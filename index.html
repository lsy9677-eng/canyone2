<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ë˜ í´ëŸ½ ë§¤ë‹ˆì € 4.9 (ìƒì˜ver)</title>
    
    <meta name="theme-color" content="#68A658">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" href="tennis.png">
    <link rel="apple-touch-icon" href="tennis.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --court-green: #68A658;
            --court-dark: #3E7C38;
            --ball-yellow: #E9F438;
            --danger: #ff5252;
            --blue-mark: #448aff;
            --bg-color: #f0f2f5;
            --seed-color: #f57f17;
            
            /* ë“±ê¸‰ë³„ ìƒ‰ìƒ */
            --tier-a: #ef5350; --bg-tier-a: #ffebee;
            --tier-am: #ffccbc; --bg-tier-am: #fff3e0;
            --tier-b: #fbc02d; --bg-tier-b: #fffde7;
            --tier-bm: #fff59d; --bg-tier-bm: #fff8e1;
            --tier-c: #66bb6a; --bg-tier-c: #e8f5e9;
            --tier-cm: #a5d6a7; --bg-tier-cm: #f1f8e9;
            --tier-d: #42a5f5; --bg-tier-d: #e3f2fd;
            
            --rank-1: #FFD700; --rank-2: #87CEEB; --rank-3: #D3D3D3;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 80px; color: #333; }

        header {
            background: var(--court-green); color: white; padding: 12px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-title { font-size: 1.1rem; display: flex; align-items: center; gap: 5px; flex-wrap: wrap;}
        .ver-sign { font-family: 'Nanum Pen Script', cursive; font-size: 1.6rem; color: var(--ball-yellow); margin: 0 4px; }
        .header-btns { display: flex; gap: 5px; }
        .btn-icon { background: rgba(255,255,255,0.25); border: none; color: white; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }

        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} }

        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .card-title { font-size: 1.2rem; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 8px; color: var(--court-dark); display: flex; justify-content: space-between; align-items: center;}
        .card-subtitle { font-size: 0.85rem; color: #888; margin-bottom: 12px; font-weight: normal; }

        .tier-board { display: flex; overflow-x: auto; gap: 4px; padding-bottom: 5px; scrollbar-width: none; }
        .tier-board::-webkit-scrollbar { display: none; }
        
        .tier-column { 
            min-width: 95px; flex: 1; border-radius: 10px; 
            border: 2px solid rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .tier-header { 
            padding: 8px 2px; text-align: center; color: white; font-size: 0.95rem; 
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1); cursor: pointer; 
        }
        .tier-header:active { opacity: 0.8; }
        .player-list { padding: 4px; flex: 1; min-height: 80px; }

        /* ì¡°ë³„ ìƒ‰ìƒ */
        .col-A { background: var(--bg-tier-a); border-color: var(--tier-a); } .col-A .tier-header { background: var(--tier-a); }
        .col-Am { background: var(--bg-tier-am); border-color: var(--tier-am); } .col-Am .tier-header { background: var(--tier-am); }
        .col-B { background: var(--bg-tier-b); border-color: var(--tier-b); } .col-B .tier-header { background: var(--tier-b); }
        .col-Bm { background: var(--bg-tier-bm); border-color: var(--tier-bm); } .col-Bm .tier-header { background: var(--tier-bm); }
        .col-C { background: var(--bg-tier-c); border-color: var(--tier-c); } .col-C .tier-header { background: var(--tier-c); }
        .col-Cm { background: var(--bg-tier-cm); border-color: var(--tier-cm); } .col-Cm .tier-header { background: var(--tier-cm); }
        .col-D { background: var(--bg-tier-d); border-color: var(--tier-d); } .col-D .tier-header { background: var(--tier-d); }

        .player-card {
            background: rgba(255,255,255,0.85); 
            padding: 6px 5px; margin-bottom: 4px; border-radius: 8px;
            display: flex; align-items: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
            min-height: 40px; position: relative;
        }
        /* ìŠ¹ê°•ê¸‰ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .player-card.promo-target { border: 2px solid var(--danger); background: #fff0f0; }
        .player-card.demo-target { border: 2px solid var(--blue-mark); background: #e3f2fd; }

        .player-img-small { width: 26px; height: 26px; border-radius: 50%; object-fit: cover; background: #ddd; border:1px solid #fff; flex-shrink: 0; }
        
        .player-name-wrap { 
            font-size: 0.85rem; color: #333; font-weight: 500; 
            flex: 1; display: flex; align-items: center; justify-content: space-between;
            overflow: visible; white-space: normal; line-height: 1.1;
        }
        .p-name { word-break: break-all; margin-right: 2px; }
        .rank-sign { font-size: 0.8rem; font-weight: bold; margin-left: 2px; }

        .folder-item {
            background: #fff8e1; border: 1px solid #ffe082; border-radius: 12px; padding: 15px 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        }
        .folder-guest { background: #e0f7fa; border: 2px solid #4dd0e1; }
        .input-full { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Jua'; font-size: 1.1rem; margin-bottom: 8px; outline: none; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; color: white; font-family: 'Jua'; margin-top: 5px; }
        
        .bg-green { background: var(--court-green); }
        .bg-blue { background: #42a5f5; }
        .bg-yellow { background: var(--ball-yellow); color: var(--court-dark); }
        .bg-gray { background: #bdbdbd; }
        .bg-red { background: var(--danger); }
        .bg-teal { background: #009688; }
        .bg-purple { background: #9c27b0; }

        .match-card { background: white; border: 2px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
        .match-card.played { background: #f1f8e9; border-color: var(--court-green); }
        .score-select { border: 2px solid #ddd; border-radius: 8px; font-family: 'Jua'; font-size: 1.3rem; width: 45px; text-align: center; height: 45px; background: white; -webkit-appearance: none; }
        .played .score-select { border-color: var(--court-green); color: var(--court-dark); font-weight: bold; }

        .result-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem; }
        .result-table th { background: var(--court-green); color: white; padding: 6px; font-weight: normal; }
        .result-table td { padding: 6px 3px; border-bottom: 1px solid #eee; }
        .rank-1 td { background-color: var(--rank-1) !important; font-weight: bold; }
        .rank-2 td { background-color: var(--rank-2) !important; font-weight: bold; }
        .rank-3 td { background-color: var(--rank-3) !important; font-weight: bold; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 2px solid #eee; display: flex; height: 65px; z-index: 90; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ccc; cursor: pointer; }
        .nav-item.active { color: var(--court-dark); transform: translateY(-2px); }
        .nav-icon { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-text { font-size: 0.8rem; }

        .admin-only { display: none !important; }
        .admin-show { display: block !important; }
        
        /* ëª¨ë‹¬ ìš°ì„ ìˆœìœ„ ì„¤ì • */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: white; width: 90%; max-width: 450px; padding: 20px; border-radius: 15px; max-height: 85vh; overflow-y: auto; border: 3px solid var(--court-green); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 3001; }
        
        #fullPhotoModal { z-index: 9999 !important; }
        #detailStatsModal { z-index: 3010 !important; }

        .seed-section { background: #fff9c4; border: 2px dashed #fbc02d; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .player-tags .tag {
            background: white; border: 1px solid #ddd;
            padding: 8px 12px; border-radius: 20px; 
            display: inline-flex; align-items: center; margin-right: 5px; margin-bottom: 5px;
            font-size: 1rem; cursor: pointer; transition: all 0.2s;
        }
        .player-tags .tag.is-seed { border-color: var(--seed-color); background-color: #fffde7; font-weight: bold; color: #e65100; }
        
        .ladder-group { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .ladder-group-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .ladder-slot { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; margin-bottom: 8px; padding: 12px; border-radius: 8px; font-size: 1.1rem; }
        .ladder-slot.seed-slot { border-left: 5px solid var(--seed-color); background: #fff8e1; }
        .ladder-slot.normal-slot { border-left: 5px solid #4facfe; }
        .slot-num { font-weight: bold; color: #555; width: 30px; }
        .slot-name { font-weight: bold; flex-grow: 1; text-align: center; }
        
        .spinning { color: #aaa; animation: blurText 0.1s infinite; }
        @keyframes blurText { 0% { opacity: 0.5; transform: translateY(-2px); } 50% { opacity: 1; transform: translateY(2px); } 100% { opacity: 0.5; transform: translateY(-2px); } }

        .profile-large { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 3px solid var(--court-green); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .photo-edit-overlay { position: absolute; bottom: 0; right: 0; background: var(--court-green); color: white; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .tie-breaker-box { background: #fff3e0; border: 2px solid #ffb74d; padding: 10px; border-radius: 10px; margin-top: 10px; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { border-color: #ffb74d; } to { border-color: #ff9800; } }
        .tie-input { width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 5px; padding: 5px; margin-left: 5px; font-family: 'Jua'; font-size:0.9rem; }
        
        .member-selector { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; max-height: 150px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; padding:5px; border-radius:8px; background:#fafafa; }
        .select-chip { font-size:0.85rem; padding:6px; background:white; border:1px solid #ddd; border-radius:6px; text-align:center; cursor:pointer; }
        .select-chip:active { background:#eee; }

        .hist-changes-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .hist-badge { padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hist-badge-up { background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .hist-badge-down { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        
        /* ë§¤ì¹˜ í”Œë ˆì´ì–´ ë¼ì¸ ì •ë ¬ ìŠ¤íƒ€ì¼ (ì‹œë“œ ì•„ì´ì½˜ ê³ ì •) */
        .match-p-line { display: flex; align-items: center; height: 24px; margin-bottom: 2px; }
        .p-left { justify-content: flex-start; }
        .p-right { justify-content: flex-end; }
        .seed-box { width: 24px; height: 24px; text-align: center; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .name-box { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }

        /* 3D ì…ì²´ ë””ìì¸ ìŠ¤íƒ€ì¼ */
        .chart-3d-box {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            box-shadow: 5px 5px 10px #d9d9d9, -5px -5px 10px #ffffff;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        /* ì…ì²´ì ì¸ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .history-item-3d {
            background: #ffffff;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-item-3d:active {
            transform: scale(0.98);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
        }
        .history-date { font-size: 0.8rem; color: #888; margin-bottom: 2px; }
        .history-title { font-weight: bold; font-size: 0.95rem; color: #333; }
        .history-score { font-weight: bold; font-size: 1rem; color: var(--court-dark); }
        
        /* í”„ë¡œí•„ìš© ë±ƒì§€ */
        .p-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display:inline-block; font-weight:bold;}
        .p-badge.up { background:#ffebee; color:red; border:1px solid red; }
        .p-badge.down { background:#e3f2fd; color:blue; border:1px solid blue; }
    </style>
</head>
<body>

<header>
    <div class="app-title">
        ğŸ¸ ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½ ì‹œí•© ë§¤ë‹ˆì € 4.9 <span class="ver-sign">(ìƒì˜ver)</span>
    </div>
    <div class="header-btns">
        <button class="btn-icon admin-only" onclick="openMemberManager()" title="íšŒì›ê´€ë¦¬">ğŸ‘¥</button>
        <button class="btn-icon admin-only" onclick="openBackupModal()" title="ë°±ì—…">ğŸ’¾</button>
        <button class="btn-icon admin-only" onclick="openAdminSettings()" title="ì„¤ì •">âš™ï¸</button>
        <button id="btnLogin" class="btn-icon" onclick="toggleAdmin()">ğŸ”’</button>
    </div>
</header>

<div id="page-rank" class="container page-section active">
    <div class="card" id="boardCaptureArea"> 
        <div class="card-title">
            <span>ğŸ“Š ë“±ê¸‰ í˜„í™©íŒ</span>
            <span style="font-size:0.85rem; color:#555; font-weight:normal;" id="realTimeClock"></span>
        </div>
        <div class="card-subtitle">ë§¤ì›” ì—…ë°ì´íŠ¸ë˜ëŠ” ìš°ë¦¬ë“¤ì˜ ëœ¨ê±°ìš´ ì½”íŠ¸ ì—´ì •! <span style="font-size:0.8rem; color:var(--court-green);" id="totalMemberCnt"></span></div>
        <div style="font-size:0.8rem; color:#999; text-align:center; margin-bottom:5px;">(ê° ì¡° ì´ë¦„ì„ ëˆ„ë¥´ë©´ ë“±ê¸‰ ë³€ë™ ë‚´ì—­ì´ ë‚˜ì˜µë‹ˆë‹¤)</div>
        <div id="unassignedArea" style="margin-bottom:10px; display:none;">
            <div style="background:#fff0f0; padding:10px; border-radius:10px; border:2px solid #ffcdd2; text-align: center;">
                <b style="color:var(--danger); font-size:1rem;">âš ï¸ ë¯¸ë°°ì •</b>
                <div id="unassignedList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; justify-content: center;"></div>
            </div>
        </div>
        <div class="tier-board" id="tierBoard"></div>
    </div>
    
    <div class="card admin-only" style="background:#fffde7; border:2px solid var(--ball-yellow);">
        <div class="card-title" style="border-bottom-color:#fbc02d;">ğŸ“… ìŠ¹ê°•ê¸‰ ê´€ë¦¬ (í´ë” ì„ íƒ)</div>
        <div style="margin-bottom:10px;">
            <label style="font-size:0.9rem; margin-bottom:3px; display:block;">ëŒ€ìƒ ëŒ€íšŒ(í´ë”) ì„ íƒ:</label>
            <select id="targetFolderSelect" class="input-full"></select>
        </div>
        <button class="btn-action bg-green" onclick="analyzeFolder()">ğŸ” ìŠ¹ê°• ëŒ€ìƒ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    
    <div id="analysisResult" class="card" style="display:none; border:3px solid var(--ball-yellow);">
        <div class="card-title">ğŸ“ˆ ìŠ¹ê°•ê¸‰ ì˜ˆìƒ ëª…ë‹¨</div>
        <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
            ìë™ìœ¼ë¡œ 1ìœ„ëŠ” ìŠ¹ê¸‰(â–²), ìµœí•˜ìœ„ëŠ” ê°•ë“±(â–¼)ì´ ì²´í¬ë©ë‹ˆë‹¤.<br>
            * 2ëª… ë¯¸ë§Œì¸ ì¡°ëŠ” ì œì™¸ë©ë‹ˆë‹¤.
        </div>
        <div id="analysisContent"></div>
        <div style="margin-top:10px; display:flex; gap:5px;">
            <button class="btn-action bg-green" onclick="applyPromotion()">âœ… í™•ì • ë° ë°˜ì˜</button>
            <button class="btn-action bg-gray" onclick="cancelAnalysis()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="page-match" class="container page-section">
    <div id="match-folders">
        <div class="card">
            <div class="card-title">
                <span>ğŸ“‚ ë§¤ì¹˜ ê¸°ë¡ì‹¤</span>
                <button id="btnNewFolder" class="btn-action bg-yellow admin-only" style="width:auto; padding:6px 12px; margin:0; font-size:0.9rem;" onclick="createNewFolderMatch()">+ ìƒˆ ë§¤ì¹˜</button>
            </div>
            <div class="card-subtitle">ììœ ë¡œìš´ ê²ŒìŠ¤íŠ¸ ë§¤ì¹˜ì™€ ì›”ë¡€ëŒ€íšŒ ê³µì‹ ê¸°ë¡</div>
            <div class="folder-item folder-guest" onclick="openFolder('Guest Zone')">
                <div style="display:flex; align-items:center;">
                    <span style="font-size:1.8rem; margin-right:10px;">ğŸ‰</span>
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem; color:#0097a7;">ê²ŒìŠ¤íŠ¸ ë§¤ì¹˜ (ììœ  ì´ìš©)</div>
                        <div style="font-size:0.8rem; color:#555;">ëˆ„êµ¬ë‚˜ ììœ ë¡­ê²Œ ë§¤ì¹˜ ìƒì„±/ê¸°ë¡ ê°€ëŠ¥</div>
                    </div>
                </div>
            </div>
            <div id="folderList"></div>
            <div id="matchEmptyMsg" style="text-align:center; padding:40px; color:#aaa; display:none;">ê³µì‹ ê¸°ë¡ ì—†ìŒ â˜ï¸</div>
        </div>
    </div>

    <div id="match-list-in-folder" style="display:none;">
        <div class="card">
            <div class="card-title">
                <div style="display:flex; align-items:center; gap:5px;">
                    <span id="currentFolderName">ğŸ“‚</span>
                    <button class="btn-icon" style="width:24px; height:24px; font-size:0.8rem; background:#eee; color:#333;" onclick="renameFolder()">âœï¸</button>
                </div>
                <button class="btn-action bg-gray" style="width:auto; padding:6px 12px; margin:0; font-size:0.9rem;" onclick="closeFolder()">â¬… ë’¤ë¡œ</button>
            </div>
            <div id="matchesInFolderArea"></div>
            <button id="btnCreateMatchInFolder" class="btn-action bg-yellow" onclick="createNewMatchInFolder()">+ ì´ í´ë”ì— ë§¤ì¹˜ ì¶”ê°€</button>
        </div>
    </div>

    <div id="match-setup" style="display:none;">
        <div class="card">
            <div class="card-title">âš™ï¸ ë§¤ì¹˜ ì„¤ì •</div>
            <input type="text" id="matchDate" class="input-full" placeholder="í´ë”ëª… (ì˜ˆ: 2024-01-01 ëª¨ë˜)">
            <input type="text" id="matchTitle" class="input-full" placeholder="ë§¤ì¹˜ëª… (ì˜ˆ: Aì¡° ì˜ˆì„ )">
            
            <div class="seed-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight:bold; color:#f57f17; font-size:1rem;">ğŸ‘‘ ì‹œë“œ ì‹œìŠ¤í…œ</div>
                    <button id="seedToggleBtn" onclick="toggleSeedSystem()" style="background:#ccc; border:none; color:white; padding:6px 12px; border-radius:12px; font-family:'Jua'; font-size:0.9rem;">OFF</button>
                </div>
                <div id="seedIconSelect" style="display:none; margin-top:10px; text-align:center;">
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="seedIcon" value="ğŸ‘‘" checked> <span style="font-size:1.2rem;">ğŸ‘‘ ì™•ê´€</span>
                    </label>
                    <label style="cursor:pointer;">
                        <input type="radio" name="seedIcon" value="ğŸ¥"> <span style="font-size:1.2rem;">ğŸ¥ ë³‘ì•„ë¦¬</span>
                    </label>
                </div>
                <div id="seedInfoText" style="font-size:0.85rem; color:#666; margin-top:8px; display:none;"></div>
            </div>

            <label style="margin-top:5px; display:block; font-size:1rem;">ì„ ìˆ˜ ë“±ë¡ (4~12ëª…)</label>
            <div style="display:flex; align-items:center; margin-bottom:5px; font-size:0.9rem;">
                <input type="checkbox" id="checkIsSeed" style="margin-right:5px;">
                <label for="checkIsSeed" style="color:#f57f17; font-weight:bold;">ğŸ‘‘ ì‹œë“œ ì„ ìˆ˜ë¡œ ë“±ë¡</label>
            </div>

            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">ğŸ‘‡ ëª…ë‹¨ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
            <div id="memberSelector" class="member-selector"></div>

            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="inputPlayerName" class="input-full" placeholder="ì´ë¦„ ì§ì ‘ ì…ë ¥" style="margin:0;" onkeypress="if(event.key==='Enter'){event.preventDefault(); addMatchPlayer();}">
                <button type="button" class="btn-action bg-green" style="width:70px; margin:0;" onclick="addMatchPlayer()">ì¶”ê°€</button>
            </div>
            
            <div style="font-size:0.8rem; color:#888; margin:5px 0;">ğŸ’¡ ì´ë¦„ì„ ëˆ„ë¥´ë©´ ì‹œë“œ/ì¼ë°˜ ìƒíƒœê°€ ë³€ê²½ë©ë‹ˆë‹¤.</div>
            <div class="player-tags" id="matchPlayerList" style="margin-bottom:15px; min-height:40px;"></div>
            
            <button class="btn-action bg-purple" onclick="goToLadder()">ğŸ² ì‚¬ë‹¤ë¦¬(ìˆœì„œ ë½‘ê¸°)</button>
            <button class="btn-action bg-gray" onclick="cancelMatchSetup()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="match-ladder" style="display:none;">
        <div class="card">
            <div class="card-title">ğŸ² ìˆœì„œ ì¶”ì²¨</div>
            <div style="text-align: center; margin: 10px 0; color: #666; font-size:0.9rem;">
                <div id="ladderStatusText">ë²ˆí˜¸ ì¶”ì²¨ ëŒ€ê¸° ì¤‘...</div>
            </div>
            <div id="ladderDisplayArea" style="min-height:150px; margin-bottom:10px;"></div>
            
            <button id="btnStartLadder" class="btn-action bg-blue" onclick="runLadderAnimation()">ğŸ° ì¶”ì²¨ ì‹œì‘ (í„°ì¹˜)</button>
            <button id="btnConfirmLadder" class="btn-action bg-green" style="display:none;" onclick="startMatchGame()">ğŸš€ ê²½ê¸° ì‹œì‘</button>
            <button class="btn-action bg-gray" style="margin-top:5px;" onclick="cancelLadderAndGoBack()">â¬… ë‹¤ì‹œ ì„¤ì •</button>
        </div>
    </div>

    <div id="match-game" style="display:none;">
        <div class="card">
            <div class="card-title">
                <div style="display:flex; align-items:center; gap:5px;">
                   <span id="gameTitleDisplay" style="font-size:1rem;"></span>
                   <button class="btn-icon" style="width:24px; height:24px; font-size:0.8rem; background:#eee; color:#333;" onclick="renameMatchTitle()">âœï¸</button>
                </div>
                <button class="btn-action bg-gray" style="width:auto; padding:5px 10px; margin:0; font-size:0.8rem;" onclick="saveAndExitMatch()">ë‚˜ê°€ê¸°</button>
            </div>
            
            <table class="result-table" style="margin-bottom:15px;">
                <thead>
                    <tr><th style="border-radius:8px 0 0 8px;">ìœ„</th><th style="text-align:left;">ì´ë¦„</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ë“</th><th>ì‹¤</th><th>ë“ì‹¤</th><th style="border-radius:0 8px 8px 0;">ìŠ¹ì </th></tr>
                </thead>
                <tbody id="gameRankingBody"></tbody>
            </table>
            
            <div id="tieBreakerBox" style="display:none;" class="tie-breaker-box">
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px; font-size:0.9rem;">âš ï¸ ë™ë¥  ë°œìƒ: ë‚˜ì´ ì…ë ¥ í•„ìš”</div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">ìŠ¹ì /ë“ì‹¤ì´ ê°™ìœ¼ë©´ ì—°ì¥ì(ë‚˜ì´ìˆœ)ê°€ ìƒìœ„ ë­í¬ë©ë‹ˆë‹¤.</div>
                <div id="tieBreakerInputs"></div>
            </div>

            <div id="gameMatchList"></div>
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-action bg-green" onclick="saveAndExitMatch()">ğŸ’¾ ì €ì¥ ë° ì¢…ë£Œ</button>
                <button class="btn-action bg-red" onclick="resetMatchScores()" style="width:40%; background:#ffcdd2; color:#d32f2f;">â†º ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>
</div>

<div id="page-history" class="container page-section">
    <div class="card">
        <div class="card-title">ğŸ“œ ë“±ê¸‰ ë³€ê²½ ë° ëŒ€íšŒ ê¸°ë¡</div>
        <div class="card-subtitle">ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½ì˜ ë°œìì·¨</div>
        <div id="historyListArea"><div style="text-align:center; padding:30px; color:#aaa;">ê¸°ë¡ ì—†ìŒ â˜ï¸</div></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="goTab('rank')">
        <span class="nav-icon">ğŸ†</span><span class="nav-text">ë“±ê¸‰í˜„í™©</span>
    </div>
    <div class="nav-item" onclick="goTab('match')">
        <span class="nav-icon">ğŸ¾</span><span class="nav-text">ë§¤ì¹˜</span>
    </div>
    <div class="nav-item" onclick="goTab('history')">
        <span class="nav-icon">ğŸ“œ</span><span class="nav-text">íˆìŠ¤í† ë¦¬</span>
    </div>
</div>

<div id="fullPhotoModal" class="modal-overlay" onclick="closeFullPhoto()">
    <div style="text-align:center; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        <img id="fullPhotoImg" src="" style="max-width:95vw; max-height:85vh; border-radius:10px; box-shadow:0 0 30px rgba(0,0,0,0.9); border:4px solid white;">
    </div>
</div>

<div id="detailStatsModal" class="modal-overlay" onclick="closeModal('detailStatsModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 id="detailTitle" style="text-align:center; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“‹ ìƒì„¸ ì„±ì í‘œ</h3>
        <div id="detailContent" style="overflow-x:auto;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('detailStatsModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="playerModal" class="modal-overlay" onclick="closeModal('playerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="text-align:center;">
            <div style="position:relative; display:inline-block;">
                <img id="pModalImg" class="profile-large" src="" onclick="openFullPhoto()" style="cursor:zoom-in;">
                <div class="photo-edit-overlay" onclick="triggerPhotoUpload()">ğŸ“·</div>
            </div>
            <div style="font-size:0.8rem; color:blue; margin-bottom:5px; cursor:pointer;" onclick="triggerPhotoUpload()">ğŸ“¸ ì‚¬ì§„ ë³€ê²½</div>
            <input type="file" id="pModalFile" style="display:none;" accept="image/*" onchange="updatePlayerPhoto(this)">
            <h3 id="pModalName" style="margin:0; color:var(--court-dark);"></h3>
            <div id="pModalTier" style="font-weight:bold; color:#666; margin-bottom:10px;"></div>
        </div>
        
        <div class="admin-only" style="background:#f5f5f5; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:5px;">
                <button onclick="manualSetTier('A')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-a); color:white;">A</button>
                <button onclick="manualSetTier('A(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-am); color:#d84315;">A-</button>
                <button onclick="manualSetTier('B')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-b); color:#333;">B</button>
                <button onclick="manualSetTier('B(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-bm); color:#333;">B-</button>
                <button onclick="manualSetTier('C')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-c); color:white;">C</button>
                <button onclick="manualSetTier('C(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-cm); color:#333;">C-</button>
                <button onclick="manualSetTier('D')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-d); color:white;">D</button>
                <button onclick="manualSetTier(null)" style="padding:8px; border:none; border-radius:5px; background:#999; color:white;">X</button>
            </div>
        </div>
        
        <input type="hidden" id="pModalPhone">
        
        <div class="chart-3d-box">
            <h4 style="margin:0 0 10px 0; color:#555;">ğŸ“Š ìŠ¹ë¥  ë° ì›”ë³„ íë¦„</h4>
            <div style="font-size:0.9rem; margin-bottom:10px;" id="playerStatsText"></div>
            <div style="display:flex; height:160px; gap:5px;">
                 <div style="width:40%; position:relative;"><canvas id="winRateChart"></canvas></div>
                 <div style="width:60%; position:relative;"><canvas id="rankLineChart"></canvas></div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:end; margin:15px 0 5px 0;">
            <h4 style="margin:0;">ğŸ… ìµœê·¼ ëŒ€íšŒ ìˆœìœ„</h4>
            <span style="font-size:0.75rem; color:#888; font-weight:normal;">(ğŸ‘‡ ê¸°ë¡ì„ ëˆ„ë¥´ë©´ ìƒì„¸ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤)</span>
        </div>
        <div id="pHistoryList" style="height:180px; overflow-y:auto; padding:2px;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('playerModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="backupModal" class="modal-overlay" onclick="closeModal('backupModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">ë°ì´í„° ë°±ì—… & ì €ì¥</h3>
        <button class="btn-action bg-teal" style="margin-top:0;" onclick="exportExcel()">ğŸ“Š ì—‘ì…€ë¡œ ëª…ë‹¨ ì €ì¥</button>
        <button class="btn-action bg-blue" onclick="exportImage()">ğŸ“¸ í˜„í™©íŒ ì‚¬ì§„ ì €ì¥</button>
        <button class="btn-action bg-gray" onclick="exportData()">ğŸ’¾ ë°±ì—… íŒŒì¼(JSON) ë‹¤ìš´</button>
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ”„ ë°ì´í„° ë³µêµ¬</div>
            <input type="file" id="restoreFile" accept=".json" style="width:100%; margin-bottom:5px;">
            <button class="btn-action bg-red" onclick="importData()">ë°ì´í„° ë³µêµ¬í•˜ê¸°</button>
        </div>
        <button class="btn-action bg-gray" onclick="closeModal('backupModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="adminSettingsModal" class="modal-overlay" onclick="closeModal('adminSettingsModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h3>
        <div style="margin-bottom:15px;">
            <label style="font-weight:bold;">ğŸ”‘ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
            <input type="text" id="newAdminPwd" class="input-full" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button class="btn-action bg-green" onclick="changeAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
        <button class="btn-action bg-gray" onclick="closeModal('adminSettingsModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="memberManagerModal" class="modal-overlay" onclick="closeModal('memberManagerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">ğŸ‘¥ íšŒì› ê´€ë¦¬</h3>
        <div style="background:#e8f5e9; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div style="font-size:0.9rem; margin-bottom:5px; font-weight:bold;" id="memberActionTitle">íšŒì› ë“±ë¡</div>
            <input type="hidden" id="currentEditPhone"> <input type="text" id="newMemberName" class="input-full" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="margin-bottom:5px;">
            <input type="text" id="newMemberPhone" class="input-full" placeholder="ì „í™”ë²ˆí˜¸ (ì„ íƒ)" style="margin-bottom:5px;">
            <div style="margin-bottom:5px;">
                <span style="font-size:0.8rem;">ğŸ“¸ í”„ë¡œí•„ ì‚¬ì§„: </span>
                <input type="file" id="newMemberPhoto" accept="image/*" style="font-size:0.8rem;">
            </div>
            <button class="btn-action bg-green" onclick="addNewMember()">ë“±ë¡ / ìˆ˜ì •</button>
            <button class="btn-action bg-red admin-only" id="btnDeleteMember" onclick="deleteMember()" style="margin-top:5px; display:none;">ğŸ—‘ï¸ íšŒì› ì‚­ì œ</button>
        </div>
        <div id="memberListForAdmin" style="height:250px; overflow-y:auto; border:1px solid #eee; border-radius:5px;"></div>
        <button class="btn-action bg-gray" style="margin-top:10px;" onclick="closeModal('memberManagerModal')">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ** [Firebase ì„¤ì •] ì‹¤ì œ ìš´ì˜ í™˜ê²½ì— ë§ê²Œ í‚¤ë¥¼ ë³€ê²½í•˜ì„¸ìš”! **
    const firebaseConfig = {
      apiKey: "AIzaSyBDdJpn7gkb_8mnHaQpp3olHuE_Un_Aj7A",
      authDomain: "lsytennis.firebaseapp.com",
      databaseURL: "https://lsytennis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lsytennis",
      storageBucket: "lsytennis.firebasestorage.app",
      messagingSenderId: "1020734955594",
      appId: "1:1020734955594:web:e458c058cad48f313ec6b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const TIERS = ['A', 'A(-)', 'B', 'B(-)', 'C', 'C(-)', 'D'];
    const TIER_STYLES = { 'A':'col-A', 'A(-)':'col-Am', 'B':'col-B', 'B(-)':'col-Bm', 'C':'col-C', 'C(-)':'col-Cm', 'D':'col-D' };
    const GUEST_FOLDER = "Guest Zone";
    const TIER_SCORES = { 'A':7, 'A(-)':6, 'B':5, 'B(-)':4, 'C':3, 'C(-)':2, 'D':1 };
    
    const REVERSE_TIER_MAP = { 'A': 'A(-)', 'A(-)': 'B', 'B': 'B(-)', 'B(-)': 'C', 'C': 'C(-)', 'C(-)': 'D', 'D': 'D' };
    const PROMOTE_TIER_MAP = { 'A(-)': 'A', 'B': 'A(-)', 'B(-)': 'B', 'C': 'B(-)', 'C(-)': 'C', 'D': 'C(-)' };
    const DOWN_TIER_MAP = { 'A': 'A(-)', 'A(-)': 'B', 'B': 'B(-)', 'B(-)': 'C', 'C': 'C(-)', 'C(-)': 'D', 'D': 'D' };

    const FIXED_SCHEDULES = {
        4: [ [1,2,3,4], [1,3,2,4], [1,4,2,3] ],
        5: [ [1,2,3,4], [1,3,2,5], [1,4,3,5], [1,5,2,4], [2,3,4,5] ],
        6: [ [1,2,3,4], [1,5,4,6], [2,3,5,6], [1,4,2,5], [2,4,3,6], [1,6,3,5] ],
        7: [ [1,2,3,4], [5,6,1,7], [3,5,2,4], [1,4,6,7], [2,3,5,7], [1,6,2,5], [4,6,3,7] ],
        8: [ [1,2,3,4], [5,6,7,8], [1,3,5,7], [2,4,6,8], [3,7,4,8], [1,5,2,6], [1,6,3,8], [2,5,4,7] ],
        9: [ [1,2,3,4], [5,6,7,8], [1,9,5,7], [2,3,6,8], [4,9,3,8], [1,5,2,6], [1,7,8,9], [3,6,4,5], [2,4,7,9] ],
        10: [ [1,2,3,4], [5,6,7,8], [2,3,6,10], [1,9,5,8], [3,10,4,5], [2,7,8,9], [4,10,6,8], [1,3,7,9], [4,6,5,9], [1,7,2,10] ],
        11: [ [1,2,3,4], [5,6,7,8], [1,11,9,10], [2,3,6,8], [4,10,5,7], [2,6,9,11], [1,3,5,11], [4,9,8,10], [1,7,2,8], [5,10,6,11], [3,9,4,7] ],
        12: [ [1,2,3,4], [5,6,7,8], [9,10,11,12], [1,5,2,6], [3,9,4,10], [7,11,8,12], [1,3,5,9], [2,4,6,10], [7,12,1,4], [8,11,2,3], [6,7,9,11], [5,8,10,12] ]
    };
    const AUTO_SEEDS = {
        4: [], 5: [], 6: [1,3], 7: [1,5], 8: [1,7], 9: [1,4,8], 10: [1,8,10], 11: [1,5,8,9], 12: [1,6,9,12]
    };
    const ALL_SEED_INFO = "6ëª…:1,3 / 7ëª…:1,5 / 8ëª…:1,7 / 9ëª…:1,4,8 / 10ëª…:1,8,10";
    const MIN_PLAYERS=4; const MAX_PLAYERS=12;

    window.allMembers = [];
    window.matchHistory = [];
    window.rankingData = { tiers: {}, history: [], settings: { adminPwd: '1234' } };
    window.isAdmin = false;
    window.analysisTemp = null;
    window.currentFolder = null; 
    window.chartInstances = { win:null, rank:null };

    window.currentMatch = { id: null, players: [], matches: [], useSeed: false, seedIcon: 'ğŸ‘‘', date: '', title: '' };

    // ì•± ì¢…ë£Œ/ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ì½”ë“œ 
    window.addEventListener('beforeunload', (event) => {
        event.preventDefault();
        event.returnValue = '';
    });
    history.pushState(null, null, location.href);

    window.onpopstate = function () {
        history.pushState(null, null, location.href); 
        alert("âš ï¸ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì„ í•œë²ˆ ë” ëˆ„ë¥´ë©´ ì•±ì€ ì¢…ë£Œ ë©ë‹ˆë‹¤.");
    };
    
    window.onload = () => {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // Firebase ë°ì´í„° ë¡œë“œ
        onValue(ref(db, 'clubData/members'), (snap) => {
            window.allMembers = snap.val() || [];
            let shouldSave = false;

            // [FIX: 3ë‹¨ê³„] phone í•„ë“œê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê¸°ì¡´ íšŒì›ì—ê²Œ ID ê°•ì œ ë¶€ì—¬
            window.allMembers.forEach(m => {
                if (!m.phone || m.phone.trim() === '') {
                    // m_fix + timestamp + random ID ë¶€ì—¬
                    m.phone = 'm_fix' + Date.now().toString().slice(-8) + Math.floor(Math.random() * 1000);
                    shouldSave = true;
                }
            });

            if (shouldSave) {
                // IDê°€ ì—†ë˜ íšŒì› ì •ë³´ë¥¼ Firebaseì— ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì˜¤ë¥˜ ìˆ˜ì •
                set(ref(db, 'clubData/members'), window.allMembers);
            }
        });
        
        onValue(ref(db, 'tennisHistory'), (snap) => {
            const val = snap.val();
            window.matchHistory = val ? Object.values(val) : [];
            populateFolderSelect();
            
            if(document.getElementById('match-game').style.display === 'block') return;
            
            if(document.getElementById('page-match').classList.contains('active')) {
                if(window.currentFolder) renderMatchesInFolder();
                else renderMatchFolderView();
            }
        });

        onValue(ref(db, 'rankingData'), (snap) => {
            if(snap.val()) window.rankingData = snap.val();
            if(!window.rankingData.tiers) window.rankingData.tiers = {};
            if(!window.rankingData.history) window.rankingData.history = [];
            if(!window.rankingData.settings) window.rankingData.settings = { adminPwd: '1234' };
            renderBoard();
            renderHistoryTab();
        });
        if(localStorage.getItem('rankAdmin') === 'true') { window.isAdmin = true; updateAdminUI(); }
    };
    
    function updateCurrentTime() {
        const now = new Date();
        const str = `${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${now.getHours()}ì‹œ ${now.getMinutes()}ë¶„`;
        document.getElementById('realTimeClock').innerText = str;
    }

    window.goTab = (tab) => {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${tab}`).classList.add('active');
        const idx = tab === 'rank' ? 0 : tab === 'match' ? 1 : 2;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(tab === 'rank') renderBoard();
        if(tab === 'match') { window.currentFolder = null; renderMatchFolderView(); }
        if(tab === 'history') renderHistoryTab();
    }

    // --- íšŒì› ê´€ë¦¬ ê¸°ëŠ¥ ìˆ˜ì •/ì¶”ê°€ (ëª©ë¡ í´ë¦­ ìˆ˜ì •/ì‚­ì œ í™œì„±í™”) ---
    window.openMemberManager = () => { 
        document.getElementById('memberManagerModal').style.display='flex'; 
        // ëª¨ë‹¬ ì—´ ë•Œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë“±ë¡ ëª¨ë“œ ì¤€ë¹„)
        document.getElementById('memberActionTitle').innerText = "íšŒì› ë“±ë¡";
        document.getElementById('currentEditPhone').value = "";
        document.getElementById('newMemberName').value = "";
        document.getElementById('newMemberPhone').value = "";
        document.getElementById('newMemberPhoto').value = "";
        document.getElementById('btnDeleteMember').style.display = 'none';

        renderMemberListForAdmin();
    }
    
    function renderMemberListForAdmin() {
        const listDiv = document.getElementById('memberListForAdmin');
        listDiv.innerHTML = window.allMembers.map(m => {
            const isInternalId = m.phone && m.phone.startsWith('m');
            const displayPhone = (m.phone && !isInternalId) ? `(${m.phone})` : '<span style="color:#aaa;">(ID)</span>';

            // [FIX: 1ë‹¨ê³„] ëª©ë¡ í´ë¦­ ì‹œ loadMemberToManager í˜¸ì¶œ
            return `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="loadMemberToManager('${m.phone}')">
                        <span style="font-weight:bold;">${m.name}</span> <span style="font-size:0.8rem; color:#666;">${displayPhone}</span>
                    </div>`;
        }).join('');
    }

    // [FIX: 2ë‹¨ê³„] Manager ëª¨ë‹¬ ì „ìš© ë¡œë” í•¨ìˆ˜
    window.loadMemberToManager = (phoneId) => {
        const member = window.allMembers.find(m => m.phone === phoneId);
        if(!member) return;

        document.getElementById('memberActionTitle').innerText = "íšŒì› ìˆ˜ì •/ì‚­ì œ";
        document.getElementById('currentEditPhone').value = member.phone;
        document.getElementById('newMemberName').value = member.name;
        
        const isInternalId = member.phone && member.phone.startsWith('m');
        // ë‚´ë¶€ IDê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ phone í•„ë“œì— ê°’ì„ ì±„ì›Œë„£ìŒ
        document.getElementById('newMemberPhone').value = isInternalId ? '' : (member.phone || ''); 
        
        document.getElementById('btnDeleteMember').style.display = 'block';
    }


    // [FIX: 2ë‹¨ê³„] ì‚­ì œ í•¨ìˆ˜
    window.deleteMember = () => {
        const phoneId = document.getElementById('currentEditPhone').value;
        const name = document.getElementById('newMemberName').value;
        
        if (!phoneId) return alert("ì‚­ì œí•  íšŒì›ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ íšŒì›ì„ í´ë¦­í•´ ì£¼ì„¸ìš”.");

        if (confirm(`ì •ë§ ${name} íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë“±ê¸‰ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) {
            // phoneIdëŠ” ì´ì œ m_fixì´ë“ , ì‹¤ì œ ì „í™”ë²ˆí˜¸ì´ë“  ê³ ìœ í•¨ì´ ë³´ì¥ë¨
            window.allMembers = window.allMembers.filter(m => m.phone !== phoneId);
            
            if(window.rankingData.tiers[phoneId]) delete window.rankingData.tiers[phoneId];

            set(ref(db, 'clubData/members'), window.allMembers)
                .then(() => set(ref(db, 'rankingData/tiers'), window.rankingData.tiers))
                .then(() => {
                    alert("íšŒì› ë° ë“±ê¸‰ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    openMemberManager(); 
                    renderBoard(); 
                    renderMemberSelector(); 
                });
        }
    }
    
    // [FIX: 2ë‹¨ê³„] ë“±ë¡/ìˆ˜ì • í•¨ìˆ˜
    window.addNewMember = async () => { 
        const name = document.getElementById('newMemberName').value.trim();
        let phone = document.getElementById('newMemberPhone').value.trim();
        const fileInput = document.getElementById('newMemberPhoto');
        const currentEditPhone = document.getElementById('currentEditPhone').value; 
        
        if(!name) return alert("ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
        
        let memberToUpdate = null;
        let isNewMember = true;
        
        if (currentEditPhone) { // ìˆ˜ì • ëª¨ë“œ
            memberToUpdate = window.allMembers.find(m => m.phone === currentEditPhone);
            isNewMember = false;
        } else { // ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
            if (!phone) {
                // ì „í™”ë²ˆí˜¸ ì—†ìœ¼ë©´ m + timestamp + random ID ê°•ì œ ìƒì„±
                phone = 'm' + Date.now().toString().slice(-10) + Math.floor(Math.random() * 100);
            } else {
                if(window.allMembers.some(m => m.phone === phone)) {
                    return alert("ì…ë ¥í•˜ì‹  ì „í™”ë²ˆí˜¸ê°€ ì´ë¯¸ ë‹¤ë¥¸ íšŒì›ì˜ IDë¡œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ìˆ˜ì •í•˜ë ¤ë©´ ëª©ë¡ì—ì„œ í•´ë‹¹ íšŒì›ì„ í´ë¦­í•˜ì„¸ìš”.");
                }
            }
            memberToUpdate = { phone, status:'ì •íšŒì›', name: name }; 
        }
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ID ê´€ë¦¬
        memberToUpdate.name = name;
        
        if(isNewMember) {
            memberToUpdate.phone = phone; 
        } else if (phone) {
             memberToUpdate.phone = phone; // ì „í™”ë²ˆí˜¸ê°€ ì…ë ¥ë˜ë©´ ì—…ë°ì´íŠ¸
        }
        
        let photo = '';
        if(fileInput.files[0]) { 
            photo = await resizeImage(fileInput.files[0], 300); 
            memberToUpdate.photo = photo;
        } 
        
        if (isNewMember) {
            window.allMembers.push(memberToUpdate);
        } else {
            const index = window.allMembers.findIndex(m => m.phone === currentEditPhone);
            if(index !== -1) window.allMembers[index] = memberToUpdate;
        }

        set(ref(db, 'clubData/members'), window.allMembers);
        alert(`íšŒì› ì •ë³´ê°€ ${isNewMember ? 'ë“±ë¡' : 'ìˆ˜ì •'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        openMemberManager(); 
        renderBoard(); 
        renderMemberSelector();
    }


    // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ---
    
    function renderBoard() {
        const board = document.getElementById('tierBoard');
        const unassignedList = document.getElementById('unassignedList');
        board.innerHTML = ''; unassignedList.innerHTML = '';
        
        const lastHistory = window.rankingData.history.length > 0 
            ? window.rankingData.history[window.rankingData.history.length - 1] : null;

        const groups = {};
        TIERS.forEach(t => {
            groups[t] = [];
            const col = document.createElement('div');
            col.className = `tier-column ${TIER_STYLES[t]}`;
            col.innerHTML = `<div class="tier-header" onclick="showTierHistory('${t}')" id="header-${t.replace(/[(-)]/g, '')}">${t} ì¡°</div><div class="player-list" id="list-${t.replace(/[(-)]/g, '')}"></div>`;
            board.appendChild(col);
        });

        let assignedCount = 0;
        window.allMembers.forEach(m => {
            if(m.status === 'íƒˆíšŒ') return;
            const tier = window.rankingData.tiers[m.phone];
            if (tier && TIERS.includes(tier)) { groups[tier].push(m); assignedCount++; }
            else {
                const btn = document.createElement('button');
                btn.className = 'btn-action';
                btn.style.cssText='width:auto; padding:6px 10px; background:#eee; color:#333; font-size:0.8rem; margin:2px;';
                btn.innerText = m.name;
                btn.onclick = () => openPlayerModal(m);
                unassignedList.appendChild(btn);
            }
        });
        
        document.getElementById('unassignedArea').style.display = (unassignedList.children.length > 0) ? 'block' : 'none';
        document.getElementById('totalMemberCnt').innerText = `ì´ ${assignedCount}ëª…`;

        TIERS.forEach(t => {
            const container = document.getElementById(`list-${t.replace(/[(-)]/g, '')}`);
            const header = document.getElementById(`header-${t.replace(/[(-)]/g, '')}`);
            header.innerText = `${t}ì¡° (${groups[t].length})`;
            const members = groups[t].sort((a,b) => a.name.localeCompare(b.name));
            
            members.forEach(m => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.onclick = () => openPlayerModal(m);
                
                let rankSign = '';
                if(lastHistory) {
                    const ch = lastHistory.changes.find(c => c.phone === m.phone);
                    if(ch) {
                        if(ch.type === 'up') { 
                            card.classList.add('promo-target'); 
                            rankSign = '<span class="rank-sign" style="color:var(--danger)">â–²</span>'; 
                        } else { 
                            card.classList.add('demo-target'); 
                            rankSign = '<span class="rank-sign" style="color:blue">â–¼</span>'; 
                        }
                    }
                }

                const imgSrc = m.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI0Ii8+PHBhdGggZD0iTTEyIDE0Yy01IDAtOSAzLjExLTkgOHgxOCIvPjwvc3ZnPg==';
                card.innerHTML = `<img src="${imgSrc}" class="player-img-small"><div class="player-name-wrap"><span class="p-name">${m.name}${rankSign}</span></div>`;
                container.appendChild(card);
            });
        });
    }

    window.goToMatchSetup = () => {
        window.currentMatch = { id: Date.now(), players: [], matches: [], useSeed: false, seedIcon: 'ğŸ‘‘', date: '', title: '' };
        document.getElementById('match-folders').style.display='none';
        document.getElementById('match-list-in-folder').style.display='none';
        document.getElementById('match-setup').style.display='block';
        
        const dateInput = document.getElementById('matchDate');
        if(window.currentFolder) {
            dateInput.value = window.currentFolder;
            dateInput.disabled = true; 
            if(window.currentFolder === GUEST_FOLDER) dateInput.style.backgroundColor = "#e0f7fa";
        } else {
            const today = new Date();
            dateInput.value = `${today.getMonth()+1}ì›” ${today.getDate()}ì¼ ëª¨ë˜`;
            dateInput.disabled = false;
        }
        document.getElementById('matchTitle').value = '';
        document.getElementById('inputPlayerName').value = '';
        renderSeedToggleUI();
        renderMatchPlayers();
        renderMemberSelector(); 
    }

    function renderMemberSelector() {
        const div = document.getElementById('memberSelector');
        div.innerHTML = '';
        
        TIERS.forEach(t => {
            const tierMembers = window.allMembers.filter(m => window.rankingData.tiers[m.phone] === t).sort((a,b)=>a.name.localeCompare(b.name));
            if(tierMembers.length > 0) {
                const groupTitle = document.createElement('div');
                groupTitle.style.cssText = "grid-column: 1/-1; font-size:0.8rem; font-weight:bold; margin-top:5px; color:#777;";
                groupTitle.innerText = `${t}ì¡°`;
                div.appendChild(groupTitle);
                
                tierMembers.forEach(m => {
                    const chip = document.createElement('div');
                    chip.className = 'select-chip';
                    chip.innerText = m.name;
                    chip.onclick = () => addMatchPlayer(m.name);
                    div.appendChild(chip);
                });
            }
        });
    }
    
    window.addMatchPlayer = (manualName = null) => {
        const name = manualName || document.getElementById('inputPlayerName').value.trim();
        const isSeedCheck = document.getElementById('checkIsSeed');
        const isSeed = window.currentMatch.useSeed && isSeedCheck.checked;
        
        if(!name) return;
        if(window.currentMatch.players.some(p=>p.name===name)) return alert("ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.");
        if(window.currentMatch.players.length >= MAX_PLAYERS) return alert(`ìµœëŒ€ ${MAX_PLAYERS}ëª…ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);

        window.currentMatch.players.push({ 
            name, isSeed: isSeed, id: Date.now()+Math.random(), 
            wins:0, draws:0, losses:0, scored:0, conceded:0, pts:0, diff:0, num:0, age:0 
        });
        
        document.getElementById('inputPlayerName').value = '';
        if(!manualName) isSeedCheck.checked = false; 
        renderMatchPlayers();
    }

    function renderMatchPlayers() {
        const iconRadios = document.getElementsByName('seedIcon');
        let selectedIcon = 'ğŸ‘‘';
        iconRadios.forEach(r => { if(r.checked) selectedIcon = r.value; });
        window.currentMatch.seedIcon = selectedIcon;

        document.getElementById('matchPlayerList').innerHTML = window.currentMatch.players.map((p,i) => `
            <div class="tag ${p.isSeed?'is-seed':''}" onclick="togglePlayerSeedStatus(${i})">
                ${p.isSeed ? selectedIcon : ''} ${p.name}
                <span style="margin-left:8px; color:#ff6b6b; font-weight:bold;" onclick="removeMatchPlayer(${i}, event)">&times;</span>
            </div>
        `).join('');
    }

    window.removeMatchPlayer = (idx, e) => {
        e.stopPropagation();
        window.currentMatch.players.splice(idx,1);
        renderMatchPlayers();
    }

    window.togglePlayerSeedStatus = (idx) => {
        if(!window.currentMatch.useSeed) return;
        window.currentMatch.players[idx].isSeed = !window.currentMatch.players[idx].isSeed;
        renderMatchPlayers();
    }

    window.toggleSeedSystem = () => {
        window.currentMatch.useSeed = !window.currentMatch.useSeed;
        renderSeedToggleUI();
        if(!window.currentMatch.useSeed) {
            window.currentMatch.players.forEach(p => p.isSeed = false);
            renderMatchPlayers();
        }
    }

    function renderSeedToggleUI() {
        const btn = document.getElementById('seedToggleBtn');
        const info = document.getElementById('seedInfoText');
        const check = document.getElementById('checkIsSeed');
        const iconSelect = document.getElementById('seedIconSelect');
        
        if(window.currentMatch.useSeed) {
            btn.innerText = "ON"; btn.style.background = "#f57f17";
            info.style.display = "block"; info.innerText = ALL_SEED_INFO;
            check.disabled = false;
            iconSelect.style.display = "block"; 
        } else {
            btn.innerText = "OFF"; btn.style.background = "#ccc";
            info.style.display = "none";
            check.disabled = true; check.checked = false;
            iconSelect.style.display = "none";
        }
    }

    window.goToLadder = () => {
        const cnt = window.currentMatch.players.length;
        if(cnt < MIN_PLAYERS || cnt > MAX_PLAYERS) return alert(`${MIN_PLAYERS}~${MAX_PLAYERS}ëª…ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        
        if(window.currentMatch.useSeed) {
            const req = (AUTO_SEEDS[cnt]||[]).length;
            const curr = window.currentMatch.players.filter(p=>p.isSeed).length;
            if(req > 0 && req !== curr) return alert(`${cnt}ëª…ì¼ ê²½ìš° ì‹œë“œ ë°°ì •ìëŠ” ì •í™•íˆ ${req}ëª…ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
        }

        document.getElementById('match-setup').style.display='none';
        document.getElementById('match-ladder').style.display='block';
        document.getElementById('btnStartLadder').style.display='block';
        document.getElementById('btnConfirmLadder').style.display='none';
        
        const displayArea = document.getElementById('ladderDisplayArea');
        displayArea.innerHTML = '';
        const statusText = document.getElementById('ladderStatusText');
        
        const allNums = Array.from({length: cnt}, (_, i) => i + 1);
        const seedNums = window.currentMatch.useSeed ? (AUTO_SEEDS[cnt] || []) : [];
        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';

        if(window.currentMatch.useSeed && seedNums.length > 0) {
            statusText.innerText = `${seedIcon} ì‹œë“œ ê·¸ë£¹ê³¼ ì¼ë°˜ ê·¸ë£¹ì„ ë‚˜ëˆ„ì–´ ì¶”ì²¨í•©ë‹ˆë‹¤.`;
            let html = `<div class="ladder-group"><div class="ladder-group-title" style="color:#e65100">${seedIcon} ì‹œë“œ ê·¸ë£¹ (ìë¦¬: ${seedNums.join(',')})</div>`;
            seedNums.forEach(num => html += createSlotHTML(num, 'seed-slot'));
            html += `</div>`;
            
            html += `<div class="ladder-group"><div class="ladder-group-title">ì¼ë°˜ ê·¸ë£¹</div>`;
            allNums.forEach(num => {
                if(!seedNums.includes(num)) html += createSlotHTML(num, 'normal-slot');
            });
            html += `</div>`;
            displayArea.innerHTML = html;
        } else {
            statusText.innerText = "ğŸ² ì „ì²´ ë¬´ì‘ìœ„ ì¶”ì²¨ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.";
            let html = `<div class="ladder-group">`;
            allNums.forEach(num => html += createSlotHTML(num, 'normal-slot'));
            html += `</div>`;
            displayArea.innerHTML = html;
        }
    }

    function createSlotHTML(num, type) {
        return `<div class="ladder-slot ${type}" id="slot-${num}">
            <div class="slot-num">${num}</div><div class="slot-name" id="slot-name-${num}">?</div>
        </div>`;
    }

    window.runLadderAnimation = async () => {
        document.getElementById('btnStartLadder').style.display='none';
        
        const players = window.currentMatch.players;
        const pCount = players.length;
        const seedNums = window.currentMatch.useSeed ? (AUTO_SEEDS[pCount] || []) : [];
        
        let seedPlayers = [], normalPlayers = [];
        
        if(window.currentMatch.useSeed && seedNums.length > 0) {
            seedPlayers = shuffleArray(players.filter(p => p.isSeed));
            normalPlayers = shuffleArray(players.filter(p => !p.isSeed));
        } else {
            normalPlayers = shuffleArray([...players]);
        }
        
        const promises = [];
        seedNums.forEach((num, i) => {
            promises.push(animateSlot(num, seedPlayers, seedPlayers[i]));
        });
        
        let nIdx = 0;
        for(let i=1; i<=pCount; i++) {
            if(!seedNums.includes(i)) {
                promises.push(animateSlot(i, normalPlayers, normalPlayers[nIdx]));
                nIdx++;
            }
        }
        
        await Promise.all(promises);
        
        if(window.currentMatch.useSeed && seedNums.length > 0) {
            seedPlayers.forEach((p, i) => p.num = seedNums[i]);
            let k = 0;
            for(let i=1; i<=pCount; i++) {
                if(!seedNums.includes(i)) { normalPlayers[k].num = i; k++; }
            }
        } else {
            normalPlayers.forEach((p, i) => p.num = i + 1);
        }
        window.currentMatch.players.sort((a,b) => a.num - b.num);

        document.getElementById('ladderStatusText').innerText = "âœ… ì¶”ì²¨ ì™„ë£Œ! ê²½ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
        document.getElementById('btnConfirmLadder').style.display='block';
    }

    function animateSlot(num, pool, finalP) {
        return new Promise(resolve => {
            const el = document.getElementById(`slot-name-${num}`);
            const duration = 1500 + Math.random() * 1500;
            el.classList.add('spinning');
            
            const timer = setInterval(() => {
                const rnd = pool[Math.floor(Math.random()*pool.length)];
                el.innerText = rnd.name;
            }, 80);
            
            setTimeout(() => {
                clearInterval(timer);
                el.classList.remove('spinning');
                el.innerText = finalP.name;
                el.style.fontWeight = "900";
                el.style.color = "#333";
                resolve();
            }, duration);
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    window.cancelLadderAndGoBack = () => {
        document.getElementById('match-ladder').style.display = 'none';
        document.getElementById('match-setup').style.display = 'block';
    }

    window.startMatchGame = () => {
        window.currentMatch.date = document.getElementById('matchDate').value || 'ë‚ ì§œë¯¸ì •';
        window.currentMatch.title = document.getElementById('matchTitle').value || 'ë¬´ëª… ë§¤ì¹˜';
        const cnt = window.currentMatch.players.length;
        
        const schedule = FIXED_SCHEDULES[cnt];
        window.currentMatch.matches = schedule.map((s, i) => ({
            id: i, 
            t1: [window.currentMatch.players[s[0]-1], window.currentMatch.players[s[1]-1]], 
            t2: [window.currentMatch.players[s[2]-1], window.currentMatch.players[s[3]-1]], 
            s1:0, s2:0, played:false
        }));
        
        saveMatchToFirebase();
        document.getElementById('match-ladder').style.display='none';
        document.getElementById('match-game').style.display='block';
        document.getElementById('gameTitleDisplay').innerText = `${window.currentMatch.date} / ${window.currentMatch.title}`;
        renderGameUI();
    }

    function renderGameUI() {
        const div = document.getElementById('gameMatchList');
        const disabledAttr = ''; 
        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';

        div.innerHTML = window.currentMatch.matches.map(m => {
            const p1 = m.t1[0], p2 = m.t1[1], p3 = m.t2[0], p4 = m.t2[1];
            
            const renderLeft = (p) => {
                const iconHtml = p.isSeed ? `<span class="seed-box">${seedIcon}</span>` : `<span class="seed-box"></span>`;
                return `<div class="match-p-line p-left">${iconHtml}<span class="name-box">${p.name}</span></div>`;
            };

            const renderRight = (p) => {
                const iconHtml = p.isSeed ? `<span class="seed-box">${seedIcon}</span>` : `<span class="seed-box"></span>`;
                return `<div class="match-p-line p-right"><span class="name-box">${p.name}</span>${iconHtml}</div>`;
            };

            return `
            <div class="match-card ${m.played?'played':''}">
                <div style="text-align:center; font-size:0.7rem; color:#aaa; margin-bottom:5px;">GAME ${m.id+1}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align:left; width:42%; font-size:0.9rem;">
                        ${renderLeft(p1)}
                        ${renderLeft(p2)}
                    </div>
                    <div style="display:flex; align-items:center; gap:3px;">
                        <select class="score-select" onchange="updateScore(${m.id}, 1, this.value)" ${disabledAttr}>${[0,1,2,3,4,5,6].map(n=>`<option value="${n}" ${m.s1==n?'selected':''}>${n}</option>`).join('')}</select>
                        <span>:</span>
                        <select class="score-select" onchange="updateScore(${m.id}, 2, this.value)" ${disabledAttr}>${[0,1,2,3,4,5,6].map(n=>`<option value="${n}" ${m.s2==n?'selected':''}>${n}</option>`).join('')}</select>
                    </div>
                    <div style="text-align:right; width:42%; font-size:0.9rem;">
                        ${renderRight(p3)}
                        ${renderRight(p4)}
                    </div>
                </div>
            </div>
        `}).join('');
        updateGameRanking();
    }

    window.updateScore = (mid, team, val) => {
        const m = window.currentMatch.matches.find(x=>x.id===mid);
        if(team===1) m.s1 = parseInt(val); else m.s2 = parseInt(val);
        m.played = (m.s1>0 || m.s2>0);
        
        if(window.currentMatch.id) set(ref(db, 'tennisHistory/' + window.currentMatch.id), window.currentMatch);
        renderGameUI();
    }
    
    window.resetMatchScores = () => {
        if(!confirm("í˜„ì¬ ë§¤ì¹˜ì˜ ëª¨ë“  ì ìˆ˜ë¥¼ 0:0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        window.currentMatch.matches.forEach(m => {
            m.s1 = 0; m.s2 = 0; m.played = false;
        });
        window.currentMatch.players.forEach(p => {
             p.wins=0; p.draws=0; p.losses=0; p.scored=0; p.conceded=0; p.pts=0; p.diff=0;
        });
        saveMatchToFirebase();
        renderGameUI();
    }

    function updateGameRanking() {
        const ps = window.currentMatch.players;
        ps.forEach(p => { p.pts=0; p.diff=0; p.scored=0; p.conceded=0; p.wins=0; p.losses=0; p.draws=0; });
        
        let allPlayed = true;
        window.currentMatch.matches.forEach(m => {
            if(!m.played) { allPlayed = false; return; }
            const diff = m.s1 - m.s2;
            const apply = (team, s, c, res) => team.forEach(tp => {
                const p = ps.find(x=>x.id===tp.id);
                p.scored+=s; p.conceded+=c; p.diff+=(s-c);
                if(res === 'win') { p.pts+=2; p.wins++; }
                else if(res === 'draw') { p.pts+=1; p.draws++; }
                else { p.losses++; }
            });

            if(diff > 0) { 
                apply(m.t1, m.s1, m.s2, 'win'); 
                apply(m.t2, m.s2, m.s1, 'loss'); 
            } else if(diff < 0) { 
                apply(m.t1, m.s1, m.s2, 'loss'); 
                apply(m.t2, m.s2, m.s1, 'win'); 
            } else { 
                apply(m.t1, m.s1, m.s2, 'draw'); 
                apply(m.t2, m.s2, m.s1, 'draw'); 
            }
        });
        
        const sorted = [...ps].sort((a,b) => {
            if(b.pts !== a.pts) return b.pts - a.pts;
            if(b.diff !== a.diff) return b.diff - a.diff;
            return (b.age || 0) - (a.age || 0);
        });

        const tieBox = document.getElementById('tieBreakerBox');
        const tieInputs = document.getElementById('tieBreakerInputs');
        tieInputs.innerHTML = '';
        
        if (allPlayed) {
            const tieGroups = {};
            ps.forEach(p => {
                const key = `${p.pts}_${p.diff}`;
                if(!tieGroups[key]) tieGroups[key] = [];
                tieGroups[key].push(p);
            });
            
            let hasTie = false;
            Object.values(tieGroups).forEach(group => {
                if(group.length > 1) {
                    hasTie = true;
                    const div = document.createElement('div');
                    div.style.marginBottom = "8px";
                    div.style.fontSize = "0.9rem";
                    div.innerHTML = `<span style="color:#e65100; font-weight:bold;">[${group[0].pts}ì  / ë“ì‹¤ ${group[0].diff}]</span> ë™ë¥  ë©¤ë²„: `;
                    
                    group.forEach(p => {
                        div.innerHTML += `
                            <span style="display:inline-block; margin:2px; white-space:nowrap;">
                                ${p.name}
                                <input type="number" class="tie-input" placeholder="ë‚˜ì´" value="${p.age||''}" onchange="updatePlayerAge(${p.id}, this.value)">
                            </span>
                        `;
                    });
                    tieInputs.appendChild(div);
                }
            });
            tieBox.style.display = hasTie ? 'block' : 'none';
        } else {
            tieBox.style.display = 'none';
        }

        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';
        document.getElementById('gameRankingBody').innerHTML = sorted.map((p,i) => {
            const nameDisp = p.isSeed ? `${seedIcon} ${p.name}` : p.name;
            return `
            <tr class="${i<1?'rank-1':i<2?'rank-2':i<3?'rank-3':''}">
                <td>${i+1}</td><td>${nameDisp}<span style="font-size:0.7rem; color:#666;">${p.age ? '('+p.age+')' : ''}</span></td>
                <td>${p.wins}</td><td>${p.draws}</td><td>${p.losses}</td><td>${p.scored}</td><td>${p.conceded}</td><td style="color:${p.diff>0?'red':p.diff<0?'blue':'#333'}">${p.diff}</td><td style="font-weight:bold;">${p.pts}</td>
            </tr>
        `}).join('');
    }

    window.updatePlayerAge = (pid, val) => {
        const p = window.currentMatch.players.find(x => x.id === pid);
        if(p) {
            p.age = parseInt(val) || 0;
            saveMatchToFirebase(); 
            renderGameUI(); 
        }
    }

    function saveMatchToFirebase() {
        if(window.currentMatch.id) set(ref(db, 'tennisHistory/' + window.currentMatch.id), window.currentMatch);
    }

    // [ìˆ˜ì •] ì €ì¥ í›„ ë·° ì „í™˜ ì‹œ ë°ì´í„° ë™ê¸°í™” ë³´ì¥
    window.saveAndExitMatch = () => { 
        if(!window.currentMatch.date && window.currentFolder) window.currentMatch.date = window.currentFolder;
        
        set(ref(db, 'tennisHistory/' + window.currentMatch.id), window.currentMatch).then(() => {
            document.getElementById('match-game').style.display='none';
            if(window.currentMatch.date) {
                window.currentFolder = window.currentMatch.date;
                document.getElementById('match-list-in-folder').style.display='block';
                const isGuest = (window.currentFolder === GUEST_FOLDER);
                document.getElementById('currentFolderName').innerText = isGuest ? `ğŸ‰ ${window.currentFolder}` : `ğŸ“‚ ${window.currentFolder}`;
                renderMatchesInFolder();
            } else { closeFolder(); }
        });
    }

    function renderHistoryTab() {
        const list = document.getElementById('historyListArea');
        if(!window.rankingData.history.length) return list.innerHTML = '<div style="text-align:center; padding:30px;">ê¸°ë¡ ì—†ìŒ</div>';
        
        list.innerHTML = [...window.rankingData.history].reverse().map((h, i) => `
            <div class="card" style="padding:15px; cursor:pointer;" onclick="openHistoryDetail(${window.rankingData.history.length-1-i})">
                <div style="font-weight:bold;">${h.title} <span style="font-weight:normal; font-size:0.8rem; color:#888;">(${h.dateString})</span></div>
                <div style="font-size:0.85rem; margin-top:5px;">${h.changes.length}ëª… ë³€ë™ / ê²°ê³¼í‘œ ë³´ê¸°</div>
                
                <div class="hist-changes-container">
                  ${h.changes.map(c => {
                      if(c.type === 'up') return `<div class="hist-badge hist-badge-up">${c.name} â–²</div>`;
                      else return `<div class="hist-badge hist-badge-down">${c.name} â–¼</div>`;
                  }).join('')}
                </div>
                
                ${window.isAdmin ? `<button class="btn-action bg-red" style="width:auto; padding:4px 10px; font-size:0.8rem; float:right; margin-top:5px;" onclick="revertHistory(event, ${window.rankingData.history.length-1-i})">â†º ë˜ëŒë¦¬ê¸°</button>` : ''}
            </div>
        `).join('');
    }

    window.revertHistory = (e, idx) => {
        e.stopPropagation();
        if(!confirm("ì´ ëŒ€íšŒì˜ ìŠ¹ê°• ê²°ê³¼ë¥¼ ì·¨ì†Œí•˜ê³ , ë“±ê¸‰ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const h = window.rankingData.history[idx];
        if(!h || !h.changes) return;

        h.changes.forEach(c => {
            const currentTier = window.rankingData.tiers[c.phone];
            if(c.type === 'up') {
                const prev = REVERSE_TIER_MAP[currentTier];
                if(prev) window.rankingData.tiers[c.phone] = prev;
            } else {
                const prev = PROMOTE_TIER_MAP[currentTier];
                if(prev) window.rankingData.tiers[c.phone] = prev;
            }
        });

        window.rankingData.history.splice(idx, 1);
        set(ref(db, 'rankingData'), window.rankingData);
        alert("ë˜ëŒë¦¬ê¸° ì™„ë£Œ! ë“±ê¸‰ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderBoard();
        renderHistoryTab();
    }

    function renderMatchFolderView() {
        document.getElementById('match-folders').style.display = 'block';
        document.getElementById('match-list-in-folder').style.display = 'none';
        document.getElementById('match-setup').style.display = 'none';
        document.getElementById('match-ladder').style.display = 'none';
        document.getElementById('match-game').style.display = 'none';
        
        const folderListDiv = document.getElementById('folderList');
        const emptyMsg = document.getElementById('matchEmptyMsg');
        const folders = {};
        window.matchHistory.forEach(m => {
            const key = m.date || "ë‚ ì§œë¯¸ì •";
            if(key === GUEST_FOLDER) return;
            if(!folders[key]) folders[key] = [];
            folders[key].push(m);
        });

        if(Object.keys(folders).length === 0) {
            folderListDiv.innerHTML = ''; emptyMsg.style.display = 'block'; 
        } else {
            emptyMsg.style.display = 'none';
            folderListDiv.innerHTML = Object.keys(folders).sort().reverse().map(date => `
                <div class="folder-item" onclick="openFolder('${date}')">
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:1.8rem; margin-right:10px;">ğŸ“‚</span>
                        <div>
                            <div style="font-weight:bold; font-size:1rem;">${date}</div>
                            <div style="font-size:0.8rem; color:#888;">${folders[date].length}ê°œ ë§¤ì¹˜</div>
                        </div>
                    </div>
                    ${window.isAdmin ? `<button class="btn-icon" style="background:#ffebee; color:red;" onclick="deleteFolder(event, '${date}')">ğŸ—‘ï¸</button>` : ''}
                </div>
            `).join('');
        }
    }
    window.openFolder = (date) => {
        window.currentFolder = date;
        document.getElementById('match-folders').style.display = 'none';
        document.getElementById('match-list-in-folder').style.display = 'block';
        const isGuest = (date === GUEST_FOLDER);
        document.getElementById('currentFolderName').innerText = isGuest ? `ğŸ‰ ${date}` : `ğŸ“‚ ${date}`;
        document.getElementById('btnCreateMatchInFolder').style.display = 'block';
        renderMatchesInFolder();
    }
    window.closeFolder = () => { window.currentFolder = null; renderMatchFolderView(); }
    window.cancelMatchSetup = () => {
         if(window.currentFolder) {
            document.getElementById('match-list-in-folder').style.display='block';
            document.getElementById('match-setup').style.display='none';
        } else { renderMatchFolderView(); }
    }

    function renderMatchesInFolder() {
        const listDiv = document.getElementById('matchesInFolderArea');
        const matches = window.matchHistory.filter(m => m.date === window.currentFolder).sort((a,b) => b.id - a.id);
        const canEdit = window.isAdmin || (window.currentFolder === GUEST_FOLDER);
        
        listDiv.innerHTML = matches.length ? matches.map(m => `
            <div class="card" style="padding:12px; margin-bottom:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;" onclick="loadMatchAndShowResult(${m.id})">
                <div>
                    <div style="font-weight:bold; font-size:1rem; margin-bottom:3px;">${m.title || 'ë¬´ì œ'}</div>
                    <div style="font-size:0.8rem; color:#666;">${m.players.length}ëª… / ${(m.matches||[]).filter(x=>x.played).length}ê²Œì„ ì™„ë£Œ</div>
                </div>
                ${canEdit ? `<button class="btn-icon" style="background:#ffebee; color:red;" onclick="deleteMatch(event, ${m.id})">ğŸ—‘ï¸</button>` : ''}
            </div>
        `).join('') : '<div style="text-align:center; padding:20px;">ë§¤ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // [ìˆ˜ì •] í”„ë¡œí•„ ëª¨ë‹¬ ë‚´ì—­ ë¡œì§ ìˆ˜ì • (ë±ƒì§€ í‘œì‹œ ê°•í™” - ëŠìŠ¨í•œ ë¹„êµ)
    window.openPlayerModal=(m)=>{ 
        const modal = document.getElementById('playerModal');
        modal.style.display='flex'; 
        document.getElementById('pModalName').innerText=m.name; 
        document.getElementById('pModalPhone').value=m.phone; 
        document.getElementById('pModalTier').innerText=window.rankingData.tiers[m.phone]||'ë¯¸ë°°ì •'; 
        document.getElementById('pModalImg').src=m.photo||''; 

        let totalGames = 0, totalWins = 0;
        let historyHtml = '';
        const myMatches = window.matchHistory.filter(h => h.players.some(p => p.name === m.name));
        myMatches.sort((a,b) => b.id - a.id); 

        let graphMap = new Map();

        myMatches.forEach(h => {
            const pData = h.players.find(p => p.name === m.name);
            if(pData) {
                totalWins += (pData.wins || 0);
                totalGames += ((pData.wins||0) + (pData.draws||0) + (pData.losses||0));
                
                let badge = '';
                // [í•µì‹¬] í´ë”ëª…(h.date)ê³¼ ìŠ¹ê°• íƒ€ì´í‹€ ë¹„êµ (ëŠìŠ¨í•œ ë¹„êµ)
                const hist = window.rankingData.history.find(hist => {
                    const matchDateNums = h.date.replace(/[^0-9]/g, '');
                    const histTitleNums = hist.title.replace(/[^0-9]/g, '');
                    // ì œëª©ì— ë‚ ì§œê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜, ë‚ ì§œê°€ ê°™ë‹¤ë©´
                    return hist.title.includes(h.date) || (matchDateNums.length > 4 && histTitleNums.includes(matchDateNums));
                });

                if (hist) {
                    const change = hist.changes.find(c => c.phone === m.phone);
                    if (change) {
                        badge = change.type === 'up' 
                            ? '<span class="p-badge up">â–² ìŠ¹ê¸‰</span>' 
                            : '<span class="p-badge down">â–¼ ê°•ë“±</span>';
                    }
                }

                historyHtml += `
                    <div class="history-item-3d" onclick="loadMatchAndShowResult(${h.id}, true)">
                        <div>
                            <div class="history-date">${h.date}</div>
                            <div class="history-title">${h.title}</div>
                        </div>
                        <div style="text-align:right;">
                             <span class="history-score">${pData.pts}ì </span>
                             <div style="font-size:0.75rem; color:#666;">${pData.wins}ìŠ¹ ${pData.draws||0}ë¬´ ${pData.losses}íŒ¨${badge}</div>
                        </div>
                    </div>`;
                
                let dateKey = h.date.substring(0, 7).replace('-', '.'); 
                if(dateKey.length < 6) dateKey = 'Others';
                
                const currentTier = window.rankingData.tiers[m.phone] || 'D';
                graphMap.set(dateKey, TIER_SCORES[currentTier] || 1);
            }
        });

        const winRate = totalGames > 0 ? Math.round((totalWins/totalGames)*100) : 0;
        document.getElementById('playerStatsText').innerText = `ì´ ${totalGames}ê²Œì„ ${totalWins}ìŠ¹ (ìŠ¹ë¥  ${winRate}%)`;
        document.getElementById('pHistoryList').innerHTML = historyHtml || '<div style="padding:10px; color:#999;">ê¸°ë¡ ì—†ìŒ</div>';
        
        if(window.chartInstances.win) window.chartInstances.win.destroy();
        const ctxWin = document.getElementById('winRateChart').getContext('2d');
        window.chartInstances.win = new Chart(ctxWin, {
            type: 'doughnut',
            data: { labels: ['ìŠ¹','íŒ¨'], datasets: [{ data: [totalWins, totalGames-totalWins], backgroundColor:['#ff6b6b','#eee'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}} }
        });

        if(window.chartInstances.rank) window.chartInstances.rank.destroy();
        const ctxRank = document.getElementById('rankLineChart').getContext('2d');
        
        const sortedKeys = Array.from(graphMap.keys()).sort();
        const graphLabels = sortedKeys.length > 0 ? sortedKeys : ['í˜„ì¬'];
        const graphData = sortedKeys.length > 0 ? sortedKeys.map(k => graphMap.get(k)) : [TIER_SCORES[window.rankingData.tiers[m.phone]||'D']];

        window.chartInstances.rank = new Chart(ctxRank, {
            type: 'line',
            data: {
                labels: graphLabels,
                datasets: [{
                    label: 'ë“±ê¸‰ ì ìˆ˜',
                    data: graphData,
                    borderColor: '#68A658',
                    backgroundColor: 'rgba(104, 166, 88, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        min: 0, max: 8, 
                        ticks: { callback: function(value) { return Object.keys(TIER_SCORES).find(key => TIER_SCORES[key] === value) || ''; } } 
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    window.loadMatchAndShowResult = (id, readOnly = false) => {
        // [ìˆ˜ì •] ID íƒ€ì… ì•ˆì „ ë¹„êµ (ë¬¸ìì—´/ìˆ«ì ëª¨ë‘ í—ˆìš©)
        const m = window.matchHistory.find(x => x.id == id); 
        if(!m) return;
        const modal = document.getElementById('detailStatsModal');
        document.getElementById('detailTitle').innerText = `${m.date} - ${m.title}`;
        
        const sorted = [...m.players].sort((a,b) => {
             if(b.pts !== a.pts) return b.pts - a.pts;
             if(b.diff !== a.diff) return b.diff - a.diff;
             return (b.age || 0) - (a.age || 0);
        });
        
        let html = `<h4 style="margin:5px 0 10px;">ğŸ† ìµœì¢… ìˆœìœ„</h4>
                    <table class="result-table" style="margin-bottom:15px;">
                        <thead><tr><th>ìœ„</th><th>ì´ë¦„</th><th>ìŠ¹ì </th><th>ë“ì‹¤</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th></tr></thead>
                        <tbody>`;
        sorted.forEach((p, i) => {
            let rankClass = (i===0)?'rank-1':(i===1)?'rank-2':(i===2)?'rank-3':'';
            html += `<tr class="${rankClass}"><td>${i+1}</td><td>${p.name}${p.age?` <small>(${p.age})</small>`:''}</td><td>${p.pts}</td><td>${p.diff}</td><td>${p.wins||0}</td><td>${p.draws||0}</td><td>${p.losses}</td></tr>`;
        });
        html += `</tbody></table>`;
        html += `<h4 style="margin:15px 0 10px;">ğŸ¾ ê²½ê¸° ê¸°ë¡</h4>`;
        m.matches.forEach((g, idx) => {
            if(!g.played) return;
            html += `<div style="background:#f9f9f9; padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span style="width:40%; text-align:left;">${g.t1[0].name},${g.t1[1].name}</span>
                        <span style="font-weight:bold;">${g.s1} : ${g.s2}</span>
                        <span style="width:40%; text-align:right;">${g.t2[0].name},${g.t2[1].name}</span>
                     </div>`;
        });
        
        if (!readOnly) {
            html += `<div style="text-align:center; margin-top:20px;">
                        <button class="btn-action bg-yellow" onclick="loadMatchToEdit(${id})">âœï¸ ì´ ë§¤ì¹˜ ìˆ˜ì •/ì…ë ¥í•˜ê¸°</button>
                     </div>`;
        }
        
        document.getElementById('detailContent').innerHTML = html;
        modal.style.display = 'flex';
    }

    window.loadMatchToEdit = (id) => {
        closeModal('detailStatsModal');
        const m = window.matchHistory.find(x => x.id == id);
        if(m) {
            window.currentMatch = JSON.parse(JSON.stringify(m));
            document.getElementById('match-folders').style.display='none';
            document.getElementById('match-list-in-folder').style.display='none';
            document.getElementById('match-game').style.display='block';
            document.getElementById('gameTitleDisplay').innerText = `${m.date} / ${m.title}`;
            renderGameUI();
        }
    }

    window.deleteFolder = (e, date) => { e.stopPropagation(); if(confirm("í´ë” ì‚­ì œ?")) { const u={}; window.matchHistory.forEach(m=>{if(m.date===date)u[`/tennisHistory/${m.id}`]=null;}); update(ref(db), u); } }
    window.deleteMatch = (e, id) => { e.stopPropagation(); if(confirm("ì‚­ì œ?")) remove(ref(db, `tennisHistory/${id}`)); }
    window.createNewFolderMatch = () => { if(!window.isAdmin) return alert("ê´€ë¦¬ìë§Œ"); window.currentFolder=null; goToMatchSetup(); }
    window.createNewMatchInFolder = () => { goToMatchSetup(); }

    window.openHistoryDetail = (idx) => { 
        const h = window.rankingData.history[idx];
        if(h) showDetailStats(h); 
    }
    
    window.showDetailStats = (data) => {
        if(!data.fullStats) return alert("ì €ì¥ëœ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const modal = document.getElementById('detailStatsModal');
        document.getElementById('detailTitle').innerText = data.title;
        let html = '';
        
        const allSorted = [...data.fullStats].sort((a,b) => b.pts - a.pts || b.diff - a.diff);
        
        TIERS.forEach(t => {
            const group = allSorted.filter(s => s.tier === t);
            if(!group.length) return;
            
            html += `<h4 style="margin:10px 0 5px; color:var(--court-dark); border-bottom:1px solid #eee;">${t}ì¡° ê²°ê³¼</h4>
                     <table class="result-table"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ìŠ¹ì </th><th>ë“ì‹¤</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th></tr></thead><tbody>`;
            
            group.forEach((p, index) => {
                 const isP = (data.promos||[]).find(x=>x.phone===p.phone);
                 const isD = (data.demos||[]).find(x=>x.phone===p.phone);
                 let nameHtml = p.name;
                 let rowStyle = '';
                 
                 if(isP) { nameHtml += ' <span style="color:red; font-weight:bold;">â–²</span>'; rowStyle = 'background:#e3f2fd;'; }
                 if(isD) { nameHtml += ' <span style="color:blue; font-weight:bold;">â–¼</span>'; rowStyle = 'background:#ffebee;'; }

                 html += `<tr style="${rowStyle}">
                    <td>${index+1}</td>
                    <td>${nameHtml}</td>
                    <td style="font-weight:bold;">${p.pts}</td>
                    <td>${p.diff}</td>
                    <td>${p.wins||0}</td>
                    <td>${p.draws||0}</td>
                    <td>${p.losses||0}</td>
                 </tr>`;
            });
            html += `</tbody></table>`;
        });

        document.getElementById('detailContent').innerHTML = html;
        modal.style.display='flex';
    }

    function populateFolderSelect() {
        const select = document.getElementById('targetFolderSelect');
        const folders = new Set();
        window.matchHistory.forEach(m => {
            if(m.date && m.date !== GUEST_FOLDER) folders.add(m.date);
        });
        
        const sorted = Array.from(folders).sort().reverse();
        select.innerHTML = sorted.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    window.analyzeFolder = () => { 
        if(!window.isAdmin) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
        const targetFolder = document.getElementById('targetFolderSelect').value;
        if(!targetFolder) return alert("ì„ íƒëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        const targetMatches = window.matchHistory.filter(h => h.date === targetFolder);
        if(!targetMatches.length) return alert("í•´ë‹¹ í´ë”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        let stats = {};
        targetMatches.forEach(match => {
            match.players.forEach(p => {
                const mem = window.allMembers.find(x => x.name === p.name);
                // ì „í™”ë²ˆí˜¸ê°€ ì—†ëŠ” íšŒì›ë„ ë¶„ì„ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì • (ë‹¤ë§Œ ë“±ê¸‰ ë§¤ì¹­ì€ phone ê¸°ì¤€ìœ¼ë¡œë§Œ ê°€ëŠ¥)
                const phone = mem ? mem.phone : `NO_PHONE_${p.name}`;
                if(!stats[phone]) stats[phone] = { 
                    name: p.name, phone: phone, 
                    wins:0, draws:0, losses:0, pts:0, diff:0, 
                    tier: window.rankingData.tiers[phone] || 'ë¯¸ë°°ì •' 
                };
                stats[phone].wins += (p.wins||0);
                stats[phone].draws += (p.draws||0);
                stats[phone].losses += (p.losses||0);
                stats[phone].pts += p.pts;
                stats[phone].diff += p.diff;
            });
        });
        
        window.analysisTemp = Object.values(stats).filter(s => s.tier !== 'ë¯¸ë°°ì •');
        if(!window.analysisTemp.length) return alert("ë¶„ì„í•  ì°¸ê°€ì ë°ì´í„°ê°€ ë“±ê¸‰ ë¯¸ë°°ì • ìƒíƒœì…ë‹ˆë‹¤.");

        let html = `<div style="max-height:300px; overflow-y:auto;">`;
        
        TIERS.forEach(t => {
            const group = window.analysisTemp.filter(s => s.tier === t)
                                            .sort((a,b) => b.pts - a.pts || b.diff - a.diff || b.wins - a.wins);
            
            if (group.length > 0) {
                html += `<h4 style="margin:10px 0 5px; border-bottom:2px solid #eee;">${t}ì¡°</h4>
                         <table class="result-table">
                            <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ìŠ¹/ê°•</th></tr></thead>
                            <tbody>`;
                
                // [ìˆ˜ì •] 2ëª… ë¯¸ë§Œì¼ ê²½ìš° ìŠ¹ê°• ì œì™¸ ë¡œì§
                const canPromote = group.length >= 2;

                group.forEach((p, idx) => {
                    let isPromoteCand = (canPromote && idx === 0 && t !== 'A'); 
                    let isDemoteCand = (canPromote && idx === group.length - 1 && t !== 'D'); 

                    let rowBg = '';
                    let checkHtml = '';

                    if (isPromoteCand) {
                        rowBg = 'background:#ffebee;'; 
                        checkHtml = `<input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="up" checked> <span style="color:red; font-weight:bold;">â–²</span>`;
                    } else if (isDemoteCand) {
                        rowBg = 'background:#e3f2fd;'; 
                        checkHtml = `<input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="down" checked> <span style="color:blue; font-weight:bold;">â–¼</span>`;
                    } else {
                        checkHtml = `
                            <label><input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="up"><small>â–²</small></label>
                            <label><input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="down"><small>â–¼</small></label>
                        `;
                    }

                    html += `<tr style="${rowBg}">
                                <td>${idx + 1}</td>
                                <td>${p.name}</td>
                                <td>${p.pts}</td>
                                <td>${checkHtml}</td>
                             </tr>`;
                });
                html += `</tbody></table>`;
            }
        });

        html += `</div>`;
        document.getElementById('analysisContent').innerHTML = html;
        document.getElementById('analysisResult').style.display='block';
    }

    window.applyPromotion = () => {
        if(!confirm("ì²´í¬ëœ ì¸ì›ë“¤ì˜ ë“±ê¸‰ì„ ë³€ê²½í•˜ê³  íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const checkboxes = document.querySelectorAll('.promo-check:checked');
        const changes = []; 
        const targetFolder = document.getElementById('targetFolderSelect').value;

        checkboxes.forEach(chk => {
            const phone = chk.dataset.phone;
            const type = chk.dataset.type; 
            const member = window.analysisTemp.find(m => m.phone === phone);
            
            if (member) {
                const currentTier = member.tier;
                let newTier = currentTier;

                if (type === 'up') {
                    newTier = PROMOTE_TIER_MAP[currentTier];
                } else if (type === 'down') {
                    newTier = DOWN_TIER_MAP[currentTier];
                }

                if (newTier && newTier !== currentTier) {
                    window.rankingData.tiers[phone] = newTier;
                    changes.push({
                        name: member.name,
                        phone: phone,
                        type: type, 
                        from: currentTier,
                        to: newTier
                    });
                }
            }
        });

        if (changes.length === 0) return alert("ë³€ê²½ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

        const historyItem = {
            id: Date.now(),
            dateString: new Date().toLocaleDateString(),
            title: `${targetFolder} ìŠ¹ê°• ê²°ê³¼`,
            changes: changes,
            fullStats: window.analysisTemp, 
            promos: changes.filter(c => c.type === 'up'),
            demos: changes.filter(c => c.type === 'down')
        };
        
        window.rankingData.history.push(historyItem);

        set(ref(db, 'rankingData'), window.rankingData)
            .then(() => {
                alert(`ì´ ${changes.length}ëª…ì˜ ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                document.getElementById('analysisResult').style.display='none';
                renderBoard(); 
            })
            .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
    }
    
    window.cancelAnalysis = () => { document.getElementById('analysisResult').style.display='none'; }
    
    window.triggerPhotoUpload=()=>{ document.getElementById('pModalFile').click(); }
    
    window.updatePlayerPhoto=async(input)=>{ if(!input.files[0])return; const f=input.files[0]; const p=document.getElementById('pModalPhone').value; const resized=await resizeImage(f,300); const idx=window.allMembers.findIndex(m=>m.phone===p); if(idx>=0){ window.allMembers[idx].photo=resized; set(ref(db,'clubData/members'), window.allMembers); document.getElementById('pModalImg').src=resized; renderBoard(); } }
    
    function resizeImage(file, max=300){ return new Promise(r=>{ const reader=new FileReader(); reader.onload=e=>{ const img=new Image(); img.onload=()=>{ const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d'); let w=img.width, h=img.height; if(w>h){if(w>max){h*=max/w; w=max;}}else{if(h>max){w*=max/h; h=max;}} cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); r(cvs.toDataURL('image/jpeg',0.8)); }; img.src=e.target.result; }; reader.readAsDataURL(file); }); }
    
    window.openFullPhoto=()=>{ 
        const src = document.getElementById('pModalImg').src;
        if(!src) return;
        document.getElementById('fullPhotoImg').src=src; 
        document.getElementById('fullPhotoModal').style.display='flex'; 
    }
    window.closeFullPhoto=()=>{ document.getElementById('fullPhotoModal').style.display='none'; }
    window.closeModal=(id)=>document.getElementById(id).style.display='none';
    window.openBackupModal=()=>document.getElementById('backupModal').style.display='flex';
    window.toggleAdmin=()=>{ if(window.isAdmin){if(confirm("ë¡œê·¸ì•„ì›ƒ?")){window.isAdmin=false; localStorage.removeItem('rankAdmin'); location.reload();}} else{if(prompt("ë¹„ë²ˆ:")===window.rankingData.settings.adminPwd){window.isAdmin=true; localStorage.setItem('rankAdmin','true'); updateAdminUI();}} }
    function updateAdminUI(){ document.querySelectorAll('.admin-only').forEach(e=>e.classList.toggle('admin-show', window.isAdmin)); document.getElementById('btnLogin').innerText=window.isAdmin?'ğŸ”“':'ğŸ”’'; }
    
    
    window.openAdminSettings=()=>{ document.getElementById('adminSettingsModal').style.display='flex'; }
    window.changeAdminPassword=()=>{ const p=document.getElementById('newAdminPwd').value; window.rankingData.settings.adminPwd=p; set(ref(db,'rankingData'), window.rankingData); alert("ë³€ê²½ì™„ë£Œ"); }
    window.manualSetTier = (tier) => {
        const phone = document.getElementById('pModalPhone').value;
        if(!phone) return;
        if(tier) window.rankingData.tiers[phone] = tier;
        else delete window.rankingData.tiers[phone]; 
        
        set(ref(db, 'rankingData/tiers'), window.rankingData.tiers);
        document.getElementById('pModalTier').innerText = tier || 'ë¯¸ë°°ì •';
        renderBoard();
    }

    window.renameFolder = () => {
        if(!window.currentFolder) return;
        const newName = prompt("ë³€ê²½í•  í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", window.currentFolder);
        if(!newName || newName === window.currentFolder) return;
        
        const updates = {};
        window.matchHistory.forEach(m => {
            if(m.date === window.currentFolder) {
                updates[`/tennisHistory/${m.id}/date`] = newName;
            }
        });
        update(ref(db), updates).then(() => {
            alert("í´ë”ëª…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.currentFolder = newName;
            document.getElementById('currentFolderName').innerText = `ğŸ“‚ ${newName}`;
            renderMatchFolderView(); 
        });
    }

    window.renameMatchTitle = () => {
        const newTitle = prompt("ë³€ê²½í•  ë§¤ì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", window.currentMatch.title);
        if(!newTitle) return;
        window.currentMatch.title = newTitle;
        update(ref(db, 'tennisHistory/' + window.currentMatch.id), { title: newTitle });
        document.getElementById('gameTitleDisplay').innerText = `${window.currentMatch.date} / ${newTitle}`;
    }

    window.exportExcel=()=>{ 
        const ws = XLSX.utils.json_to_sheet(window.allMembers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Members");
        XLSX.writeFile(wb, "members_backup.xlsx");
    }
    window.exportImage=()=>{ 
        html2canvas(document.getElementById('boardCaptureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'rank_board.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
    window.exportData=()=>{ 
        const data = { members: window.allMembers, history: window.matchHistory, rank: window.rankingData };
        const blob = new Blob([JSON.stringify(data)], {type : 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
    }
    window.importData=()=>{ alert("íŒŒì¼ ì„ íƒ í›„ ë³µêµ¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”(ë¡œì§ ë¯¸êµ¬í˜„)"); }
    
</script>
</body>
</html>